<!doctype html>
<html>

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <!-- Style definitions have been moved to Tailwind CSS classes within the HTML elements -->

  <title>[[title]] Transcript Summary</title>
  <script>
    const CHAPTERS = [[chapters]];
    const SNAPSHOTS = [[snapshots]];
    const TRANSCRIPT = [[transcript]];

    function insertImages() {
      var summaries = document.querySelectorAll(
        ".chapters-container div[data-start]",
      );
      var snapshots = document.querySelectorAll(".snapshots-container img");

      summaries.forEach(function (summary) {
        var startTime = summary.getAttribute("data-start");
        var imageName = startTimeToImageName(startTime);
        var startSeconds = timeStringToSeconds(startTime);

        // Move existing children (except img) to textContent div
        var textContent = document.createElement("div");
        textContent.className = "text-content";
        Array.from(summary.childNodes).forEach(function (child) {
          textContent.appendChild(child);
        });

        var imageContent = document.createElement("div");
        imageContent.className = "img-content";
        var images = Array.from(snapshots).forEach(function (snapshot, i) {
          var snapshotStart = timeStringToSeconds(
            snapshot.getAttribute("data-start"),
          );
          if (snapshotStart < startSeconds) return;

          if (imageContent.children.length === 0) {
            snapshot.classList.add("active");
          }

          imageContent.appendChild(snapshot);
          var zoomedContainer = document.querySelector(".zoomed");
          var zoomedImage = zoomedContainer.querySelector("img");
          var legend = zoomedContainer.querySelector(".legend");
          snapshot.onmouseover = function () {
            zoomedContainer.style.display = "block";
            zoomedImage.src = snapshot.src;
            var legend = zoomedContainer.querySelector(".legend");
            legend.textContent =
              "Start Time: " + this.getAttribute("data-start");
          };
          snapshot.onmouseout = function () {
            zoomedContainer.style.display = "none";
          };
        });

        summary.appendChild(textContent);
        summary.appendChild(imageContent);
      });
    }

    function centerOnPlayingElement() {
      // TODO rewrite
      var playingElement = document.querySelector(".vtt-container .playing");
      if (playingElement) {
        var container = document.querySelector(".vtt-container");
        var elementRect = playingElement.getBoundingClientRect();
        var containerRect = container.getBoundingClientRect();

        // Calculate the position to scroll to
        var scrollTo =
          playingElement.offsetTop -
          container.offsetTop -
          containerRect.height / 2 +
          elementRect.height / 2;

        // Scroll the container
        container.scrollTop = scrollTo;
      }
    }

    function startTimeToImageName(startTime) {
      // Assuming startTime format is 'mm:ss'
      var parts = startTime.split(":");
      var minutes = parts[0];
      var seconds = parts[1];
      return minutes + "_" + seconds + ".jpg";
    }

    function setAudioPlayerOffset(start) {
      var audioPlayer = document.getElementById("audioPlayer");
      var source = document.getElementById("audioSource");

      var isPlaying = !audioPlayer.paused;
      source.src = "./audio.mp3#t=" + start;
      audioPlayer.load();
      if (isPlaying) {
        audioPlayer.play();
      }
    }

    function updateHighlightBasedOnTime() {
      let audioPlayer = document.getElementById("audioPlayer");
      let currentTime = audioPlayer.currentTime;

      const markPlayingElement = (summaries) => {
        let activeElement = false;
        Array.from(summaries)
          .reverse()
          .forEach(function (summary) {
            let startTime = timeStringToSeconds(
              summary.getAttribute("data-start"),
            );

            if (currentTime >= startTime && !activeElement) {
              summary.classList.add("playing");
              activeElement = true;
            } else {
              summary.classList.remove("playing");
            }
          });
      };
      markPlayingElement(
        document.querySelectorAll(".chapters-container div[data-start]"),
      );
      markPlayingElement(
        document.querySelectorAll(".vtt-container div[data-start]"),
      );

      centerOnPlayingElement();

      displayClosestImage(currentTime);
    }

    function displayClosestImage(currentTime) {
      let snapshots = document.querySelectorAll(".snapshots-container img");
      let closestSnapshot = null;
      let closestTimeDiff = Number.MAX_VALUE;

      snapshots.forEach((snapshot) => {
        let snapshotTime = timeStringToSeconds(snapshot.getAttribute("data-start"));
        let timeDiff = Math.abs(currentTime - snapshotTime);
        if (timeDiff < closestTimeDiff) {
          closestTimeDiff = timeDiff;
          closestSnapshot = snapshot;
        }
      });

      if (closestSnapshot) {
        snapshots.forEach((snapshot) => snapshot.style.display = 'none');
        closestSnapshot.style.display = 'block';
      }
    }

    function preprocessVTTContent() {
      TRANSCRIPT.forEach(function (entry) {
        const start = entry.start;
        const end = entry.end;
        const text = entry.text;
        const summaryElement = findSummaryForTime(start);
        if (summaryElement) {
          const transcriptDiv = document.createElement('div');
          transcriptDiv.textContent = text;
          transcriptDiv.setAttribute('data-start', start);
          transcriptDiv.setAttribute('data-end', end);
          summaryElement.querySelector('.transcripts').appendChild(transcriptDiv);
        }
      });
    }

    function findSummaryForTime(time) {
      const summaries = document.querySelectorAll('.summary-container');
      const summariesSortedByStartTime = Array.from(summaries).sort((a, b) => {
        return timeStringToSeconds(a.getAttribute('data-start')) - timeStringToSeconds(b.getAttribute('data-start'));
      });
      for (let i = summariesSortedByStartTime.length - 1; i >= 0; i--) {
        const summaryStart = summariesSortedByStartTime[i].getAttribute('data-start');
        if (timeStringToSeconds(time) >= timeStringToSeconds(summaryStart)) {
          return summariesSortedByStartTime[i];
        }
      }
      return null;
    }

    function preprocessSnapshots() {
      const snapshotsContainer = document.querySelector(
        ".snapshots-container",
      );
      SNAPSHOTS.forEach((snapshot) => {
        let start = snapshot.start;
        let source = snapshot.source;
        let snapshotImage = document.createElement("img");
        snapshotImage.setAttribute("data-start", start);
        snapshotImage.setAttribute("src", source);
        snapshotsContainer.appendChild(snapshotImage);
      });
    }

    function preprocessChapters() {
      const chaptersContainer = document.querySelector(
        ".chapters-container",
      );
      CHAPTERS.forEach((chapter) => {
        let title = chapter.title;
        let description = chapter.description;
        let chapterDiv = document.createElement("div");
        chapterDiv.innerHTML = `
          <h2>${marked.parse(title)}</h2>
          <p>${marked.parse(description)}</p>
        `;
        chaptersContainer.appendChild(chapterDiv);

        chapter.summaries.forEach((summary) => {
          let start = summary.start;
          let title = summary.title;
          let summaryStartTime = timeStringToSeconds(start);
          let description = summary.description;
          let summaryDiv = document.createElement("div");
          summaryDiv.setAttribute("data-start", start);
          summaryDiv.setAttribute("class", "summary-container");
          summaryDiv.innerHTML = `
            <p>
              <b>${start}</b> : ${marked.parse(description)}
            </p>
            <div class="transcripts"></div>
          `;
          chapterDiv.appendChild(summaryDiv);
        });
      });
    }

    function timeStringToSeconds(timeString) {
      let parts = timeString.split(":");

      let hours = 0;
      let minutes = parseInt(parts[0], 10);
      let seconds = parseInt(parts[1], 10);

      if (parts.length > 2) {
        let secondsParts = parts[2].split(".");
        hours = parseInt(parts[0], 10);
        minutes = parseInt(parts[1], 10);
        seconds = parseInt(secondsParts[0], 10);
      }

      return hours * 3600 + minutes * 60 + seconds;
    }

    function toggleContainer(container) {
      let containers = document.querySelectorAll(container);
      Array.from(containers).forEach(function (container) {
        container.style.display =
          container.style.display === "block" ? "none" : "block";
      });
    }

    document.addEventListener("DOMContentLoaded", function () {
      insertImages();
      preprocessChapters();
      preprocessSnapshots();
      preprocessVTTContent();

      let summaryDivs = document.querySelectorAll("div[data-start]");
      summaryDivs.forEach(function (div) {
        div.addEventListener("click", function () {
          let start = this.getAttribute("data-start");
          setAudioPlayerOffset(start);
        });
      });

      summaryDivs = document.querySelectorAll("div[data-chapter-start]");
      summaryDivs.forEach(function (div) {
        let start = div.getAttribute("data-chapter-start");
        div.querySelector("h2").addEventListener("click", function () {
          setAudioPlayerOffset(start);
        });
      });

      let audioPlayer = document.getElementById("audioPlayer");
      audioPlayer.addEventListener("timeupdate", updateHighlightBasedOnTime);
    });
  </script>
</head>

<body class="m-0 font-sans">
  <div class="text-center h-20">
    <h1 class="text-center w-full px-10">[[title]]</h1>
  </div>

  <div class="flex h-screen">
    <div class="flex-1 overflow-y-auto p-5">
      <div class="container">[[description]]</div>
    </div>
  </div>

  <div class="flex justify-between items-center h-25">
    <audio id="audioPlayer" controls>
      <source id="audioSource" src="./audio.mp3" type="audio/mpeg" />
      Your browser does not support the audio element.
    </audio>
    <div class="snapshots-container"></div>
  </div>

  <div class="zoomed">
    <img src="" alt="" />
    <div class="legend"></div>
  </div>
</body>
</html>
