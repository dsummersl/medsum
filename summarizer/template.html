<!doctype html>
<html>

<head>
  <title>[[title]] Transcript Summary</title>
  <style>
    body {
      margin: 0px;
      font-family: Arial, sans serif;
    }

    h1 {
      text-align: center;
      width: calc(100% - 80px);
    }

    .header {
      text-align: center;
      height: 80px;
    }

    .container {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
    }

    .main-container {
      display: flex;
      height: calc(100vh - 100px - 80px - 21px);
    }

    .chapters-container {
      flex: 1 1 66%;
    }

    .vtt-container {
      flex: 1 1 33%;
      white-space: pre-wrap;
      /* To preserve formatting of VTT file */
      display: none;
    }

    .audio-container {
      display: flex;
      justify-content: space-between;
      align-items: center;
      height: 100px;
    }

    .snapshots-container {
      height: 100%; /* Match the height of the audio-container */
      display: flex;
      align-items: center; /* Align the image vertically */
      justify-content: flex-end; /* Align the image to the right */
      overflow: hidden; /* Hide other images if they don't fit */
      margin-right: 15px;
    }

    .snapshots-container audio {
      margin-left: 10px;
    }

    .snapshots-container img {
      display: none; /* Hide all images by default */
      height: 100%; /* Scale the visible image to fill the container height */
    }

    .snapshots-container img:first-child {
      display: block; /* Only display the first image */
    }

    .vtt-container div {
      font:
        10px Arial,
        monospace;
    }

    .vtt-container div[data-start] {
      margin-top: 10px;
    }

    .chapters-container>div {
      display: flex;
      flex-direction: column;
      margin-bottom: 10px;
      padding: 10px;
      transition: background-color 0.3s ease;
    }

    .text-content {
      flex: 2 1 66%;
      margin-right: 10px;
      display: flex;
      flex-direction: column;
    }

    .img-content {
      max-width: 200px;
      height: auto;
      margin-left: auto;
    }

    .img-content img {
      max-width: 30px;
      /* Thumbnail size */
      height: auto;
      margin: 0 5px;
      cursor: pointer;
      opacity: 0.6;
      transition: all 0.3s ease;
    }

    .img-content img.active {
      max-width: 200px;
      opacity: 1;
    }

    .chapters-container div[data-start]:hover,
    .chapters-container div[data-start].highlight {
      background-color: #f0f0f0;
    }

    div[data-start].playing {
      background-color: #ffdab9;
      /* light orange */
    }

    .zoomed {
      position: fixed;
      z-index: 10;
      display: none;
      /* Hidden by default */
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background-color: #fff;
      /* Or any background color you prefer */
      padding: 10px;
      border-radius: 5px;
      box-shadow: 0 0 8px rgba(0, 0, 0, 0.5);
    }

    .zoomed img {
      max-width: 100%;
      /* Adjust as necessary */
      height: auto;
    }

    .legend {
      text-align: center;
      margin-top: 10px;
      font-size: 16px;
      color: #333;
      /* Text color */
    }
  </style>
  <script>
    const CHAPTERS = [[chapters]];
    const SNAPSHOTS = [[snapshots]];
    const TRANSCRIPT = [[transcript]];

    function insertImages() {
      var summaries = document.querySelectorAll(
        ".chapters-container div[data-start]",
      );
      var snapshots = document.querySelectorAll(".snapshots-container img");

      summaries.forEach(function (summary) {
        var startTime = summary.getAttribute("data-start");
        var imageName = startTimeToImageName(startTime);
        var startSeconds = timeStringToSeconds(startTime);

        // Move existing children (except img) to textContent div
        var textContent = document.createElement("div");
        textContent.className = "text-content";
        Array.from(summary.childNodes).forEach(function (child) {
          textContent.appendChild(child);
        });

        var imageContent = document.createElement("div");
        imageContent.className = "img-content";
        var images = Array.from(snapshots).forEach(function (snapshot, i) {
          var snapshotStart = timeStringToSeconds(
            snapshot.getAttribute("data-start"),
          );
          if (snapshotStart < startSeconds) return;

          if (imageContent.children.length === 0) {
            snapshot.classList.add("active");
          }

          imageContent.appendChild(snapshot);
          var zoomedContainer = document.querySelector(".zoomed");
          var zoomedImage = zoomedContainer.querySelector("img");
          var legend = zoomedContainer.querySelector(".legend");
          snapshot.onmouseover = function () {
            zoomedContainer.style.display = "block";
            zoomedImage.src = snapshot.src;
            var legend = zoomedContainer.querySelector(".legend");
            legend.textContent =
              "Start Time: " + this.getAttribute("data-start");
          };
          snapshot.onmouseout = function () {
            zoomedContainer.style.display = "none";
          };
        });

        summary.appendChild(textContent);
        summary.appendChild(imageContent);
      });
    }

    function centerOnPlayingElement() {
      var playingElement = document.querySelector(".vtt-container .playing");
      if (playingElement) {
        var container = document.querySelector(".vtt-container");
        var elementRect = playingElement.getBoundingClientRect();
        var containerRect = container.getBoundingClientRect();

        // Calculate the position to scroll to
        var scrollTo =
          playingElement.offsetTop -
          container.offsetTop -
          containerRect.height / 2 +
          elementRect.height / 2;

        // Scroll the container
        container.scrollTop = scrollTo;
      }
    }

    function startTimeToImageName(startTime) {
      // Assuming startTime format is 'mm:ss'
      var parts = startTime.split(":");
      var minutes = parts[0];
      var seconds = parts[1];
      return minutes + "_" + seconds + ".jpg";
    }

    function setAudioPlayerOffset(start) {
      var audioPlayer = document.getElementById("audioPlayer");
      var source = document.getElementById("audioSource");

      var isPlaying = !audioPlayer.paused;
      source.src = "./audio.mp3#t=" + start;
      audioPlayer.load();
      if (isPlaying) {
        audioPlayer.play();
      }
    }

    function updateHighlightBasedOnTime() {
      let audioPlayer = document.getElementById("audioPlayer");
      let currentTime = audioPlayer.currentTime;

      const markPlayingElement = (summaries) => {
        let activeElement = false;
        Array.from(summaries)
          .reverse()
          .forEach(function (summary) {
            let startTime = timeStringToSeconds(
              summary.getAttribute("data-start"),
            );

            if (currentTime >= startTime && !activeElement) {
              summary.classList.add("playing");
              activeElement = true;
            } else {
              summary.classList.remove("playing");
            }
          });
      };
      markPlayingElement(
        document.querySelectorAll(".chapters-container div[data-start]"),
      );
      markPlayingElement(
        document.querySelectorAll(".vtt-container div[data-start]"),
      );

      centerOnPlayingElement();

      displayClosestImage(currentTime);
    }

    function displayClosestImage(currentTime) {
      let snapshots = document.querySelectorAll(".snapshots-container img");
      let closestSnapshot = null;
      let closestTimeDiff = Number.MAX_VALUE;

      snapshots.forEach((snapshot) => {
        let snapshotTime = timeStringToSeconds(snapshot.getAttribute("data-start"));
        let timeDiff = Math.abs(currentTime - snapshotTime);
        if (timeDiff < closestTimeDiff) {
          closestTimeDiff = timeDiff;
          closestSnapshot = snapshot;
        }
      });

      if (closestSnapshot) {
        snapshots.forEach((snapshot) => snapshot.style.display = 'none');
        closestSnapshot.style.display = 'block';
      }
    }

    function preprocessVTTContent() {
      let vttContainer = document.querySelector(".vtt-container");
      let lines = vttContainer.textContent.split("\n");
      let processedHTML = "";
      let currentChapter = null;
      let currentSummary = null;

      lines.forEach(function (line) {
        let chapterMatch = line.match(/^\s*Chapter\s+(\d+): (.*)$/);
        let summaryMatch = line.match(/^\s*Summary\s+(\d+): (.*)$/);
        let transcriptMatch = line.match(/^\s*(\d\d:\d\d:\d\d)\s+(.*)$/);

        if (chapterMatch) {
          currentChapter = document.querySelector(`div[data-chapter-start="${chapterMatch[1]}"]`);
        } else if (summaryMatch) {
          currentSummary = currentChapter.querySelector(`div[data-start="${summaryMatch[1]}"]`);
        } else if (transcriptMatch && currentSummary) {
          let start = transcriptMatch[1];
          let text = transcriptMatch[2];
          processedHTML += `<div data-start="${start}">${text.trim()}</div>`;
        }
      });

      if (currentSummary) {
        currentSummary.innerHTML += processedHTML;
      }
    }

    function preprocessSnapshots() {
      const snapshotsContainer = document.querySelector(
        ".snapshots-container",
      );
      SNAPSHOTS.forEach((snapshot) => {
        let start = snapshot.start;
        let source = snapshot.source;
        let snapshotImage = document.createElement("img");
        snapshotImage.setAttribute("data-start", start);
        snapshotImage.setAttribute("src", source);
        snapshotsContainer.appendChild(snapshotImage);
      });
    }

    function preprocessChapters() {
      const chaptersContainer = document.querySelector(
        ".chapters-container",
      );
      CHAPTERS.forEach((chapter) => {
        let start = chapter.start;
        let title = chapter.title;
        let description = chapter.description;
        let chapterDiv = document.createElement("div");
        chapterDiv.setAttribute("data-chapter-start", start);
        chapterDiv.innerHTML = `
          <h2>${title}</h2>
          <p>${description}</p>
        `;
        chaptersContainer.appendChild(chapterDiv);

        chapter.summaries.forEach((summary) => {
          let start = summary.start;
          let title = summary.title;
          let summaryStartTime = timeStringToSeconds(start);
          let description = summary.description;
          let summaryDiv = document.createElement("div");
          summaryDiv.setAttribute("data-start", start);
          summaryDiv.innerHTML = `
            <p>
              <b>${start}</b> : ${description}
            </p>
          `;
          chapterDiv.appendChild(summaryDiv);
        });
      });
    }

    function timeStringToSeconds(timeString) {
      let parts = timeString.split(":");

      let hours = 0;
      let minutes = parseInt(parts[0], 10);
      let seconds = parseInt(parts[1], 10);

      if (parts.length > 2) {
        let secondsParts = parts[2].split(".");
        hours = parseInt(parts[0], 10);
        minutes = parseInt(parts[1], 10);
        seconds = parseInt(secondsParts[0], 10);
      }

      return hours * 3600 + minutes * 60 + seconds;
    }

    function toggleContainer(container) {
      let containers = document.querySelectorAll(container);
      Array.from(containers).forEach(function (container) {
        container.style.display =
          container.style.display === "block" ? "none" : "block";
      });
    }

    document.addEventListener("DOMContentLoaded", function () {
      insertImages();
      preprocessVTTContent();
      preprocessChapters();
      preprocessSnapshots();

      let summaryDivs = document.querySelectorAll("div[data-start]");
      summaryDivs.forEach(function (div) {
        div.addEventListener("click", function () {
          let start = this.getAttribute("data-start");
          setAudioPlayerOffset(start);
        });
      });

      summaryDivs = document.querySelectorAll("div[data-chapter-start]");
      summaryDivs.forEach(function (div) {
        let start = div.getAttribute("data-chapter-start");
        div.querySelector("h2").addEventListener("click", function () {
          setAudioPlayerOffset(start);
        });
      });

      let audioPlayer = document.getElementById("audioPlayer");
      audioPlayer.addEventListener("timeupdate", updateHighlightBasedOnTime);

      document
        .getElementById("toggleTranscript")
        .addEventListener("click", () => toggleContainer(".vtt-container"));
    });
  </script>
</head>

<body>
  <div class="header">
    <h1>[[title]]</h1>
  </div>

  <div class="main-container">
    <div class="container chapters-container">
      <div class="container summary-container">[[description]]</div>
    </div>
  </div>

  <div class="audio-container">
    <audio id="audioPlayer" controls>
      <source id="audioSource" src="./audio.mp3" type="audio/mpeg" />
      Your browser does not support the audio element.
    </audio>
    <div class="snapshots-container"></div>
  </div>

  <div class="zoomed">
    <img src="" alt="" />
    <div class="legend"></div>
  </div>
</body>
</html>
